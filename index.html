<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Battleship Radar Command</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Orbitron', monospace;
      background: radial-gradient(circle at center, #0a1a0a 0%, #000 70%);
      color: #00ff41;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      overflow-x: auto;
    }

    .radar-container {
      background: linear-gradient(145deg, #001100, #002200);
      border: 2px solid #00ff41;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 
        0 0 30px #00ff4150,
        inset 0 0 20px #00330a;
      max-width: 1400px;
      width: 100%;
    }

    .command-header {
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(90deg, #003300, #001a00, #003300);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #00ff41;
      box-shadow: 0 0 15px #00ff4130;
      position: relative; /* Added for exit button positioning */
    }

    .command-header h1 {
      font-size: 2.2em;
      font-weight: 900;
      letter-spacing: 3px;
      text-shadow: 0 0 10px #00ff41;
      margin-bottom: 10px;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41; }
      to { text-shadow: 0 0 20px #00ff41, 0 0 30px #00ff41, 0 0 40px #00ff41; }
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, #001a00, #002200);
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #00ff41;
      margin-bottom: 20px;
      box-shadow: inset 0 2px 5px #00110050;
    }

    .mode-selector {
      display: flex;
      gap: 10px;
    }

    .mode-btn {
      background: linear-gradient(145deg, #003300, #001100);
      color: #00ff41;
      border: 1px solid #00ff41;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .mode-btn:hover, .mode-btn.active {
      background: linear-gradient(145deg, #00ff41, #00cc33);
      color: #000;
      box-shadow: 0 0 15px #00ff41;
      text-shadow: none;
    }

    .radar-stats {
      display: flex;
      gap: 20px;
      font-size: 0.9em;
      font-weight: 700;
    }

    .stat-item {
      text-align: center;
      background: linear-gradient(145deg, #001a00, #000800);
      padding: 5px 12px;
      border-radius: 5px;
      border: 1px solid #00ff4150;
      min-width: 80px;
    }

    .stat-value {
      font-size: 1.2em;
      color: #00ff41;
      text-shadow: 0 0 5px #00ff41;
    }

    .status-message {
      background: linear-gradient(90deg, #001100, #002200, #001100);
      color: #00ff41;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 700;
      text-align: center;
      margin-bottom: 20px;
      border: 1px solid #00ff41;
      box-shadow: 0 0 10px #00ff4130;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .battle-interface {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
      justify-content: center;
    }

    .ship-command {
      background: linear-gradient(145deg, #001a00, #000a00);
      border: 2px solid #00ff41;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px #00ff4130;
      min-width: 250px;
    }

    .ship-command h3 {
      color: #00ff41;
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.1em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #00ff41;
    }

    .fleet-roster {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .ship-selector {
      background: linear-gradient(145deg, #002200, #001100);
      border: 1px solid #00ff41;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-weight: 700;
      color: #00ff41;
      position: relative;
      font-size: 0.9em;
      letter-spacing: 1px;
    }

    .ship-selector:hover {
      background: linear-gradient(145deg, #003300, #002200);
      box-shadow: 0 0 10px #00ff41;
      transform: translateY(-1px);
    }

    .ship-selector.selected {
      background: linear-gradient(145deg, #00ff41, #00cc33);
      color: #000;
      animation: radarPulse 1.5s infinite;
    }

    .ship-selector.deployed {
      background: linear-gradient(145deg, #222, #111);
      color: #666;
      opacity: 0.6;
      cursor: not-allowed;
      filter: grayscale(0.7);
    }

    @keyframes radarPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); box-shadow: 0 0 20px #00ff41; }
    }

    .command-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-button {
      background: linear-gradient(145deg, #003300, #001800);
      color: #00ff41;
      border: 1px solid #00ff41;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.85em;
      font-weight: 700;
      font-family: 'Orbitron', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .control-button:hover {
      background: linear-gradient(145deg, #004400, #002200);
      box-shadow: 0 0 8px #00ff41;
    }

    .control-button:disabled {
      background: linear-gradient(145deg, #111, #080808);
      color: #666;
      border-color: #333;
      cursor: not-allowed;
      box-shadow: none;
    }

    .tactical-systems {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #00ff4150;
    }

    .tactical-button {
      background: linear-gradient(145deg, #440000, #220000);
      color: #ff4444;
      border: 1px solid #ff4444;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.3s;
      margin-bottom: 5px;
      width: 100%;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      text-transform: uppercase;
    }

    .tactical-button:hover:not(:disabled) {
      background: linear-gradient(145deg, #660000, #330000);
      box-shadow: 0 0 10px #ff444450;
    }

    .tactical-button:disabled {
      background: linear-gradient(145deg, #111, #080808);
      color: #666;
      border-color: #333;
      cursor: not-allowed;
    }

    .radar-screen {
      background: 
        radial-gradient(circle at center, #002200 0%, #001100 40%, #000800 100%),
        repeating-linear-gradient(0deg, transparent, transparent 31px, #00ff4108 32px),
        repeating-linear-gradient(90deg, transparent, transparent 31px, #00ff4108 32px);
      border: 3px solid #00ff41;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 
        0 0 30px #00ff4150,
        inset 0 0 30px #00110020;
      position: relative;
    }

    .radar-screen::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #00ff41, #00cc33, #00ff41);
      border-radius: 18px;
      z-index: -1;
      animation: borderGlow 3s ease-in-out infinite alternate;
    }

    @keyframes borderGlow {
      from { opacity: 0.5; }
      to { opacity: 1; }
    }

    .screen-title {
      font-size: 1.1em;
      font-weight: 700;
      color: #00ff41;
      text-align: center;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #00ff41;
      background: linear-gradient(90deg, #001a00, #002200, #001a00);
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #00ff4150;
    }

    .grid-display {
      position: relative;
      display: inline-block;
    }

    .coordinate-labels {
      position: absolute;
      color: #00ff41;
      font-weight: 700;
      font-size: 11px;
      text-shadow: 0 0 3px #00ff41;
    }

    .coordinate-labels.letters {
      top: -18px;
      left: 20px;
      display: flex;
      width: 320px;
    }

    .coordinate-labels.numbers {
      left: -18px;
      top: 5px;
      display: flex;
      flex-direction: column;
      height: 320px;
    }

    .coordinate-labels span {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      font-weight: 700;
    }

    .radar-grid {
      display: grid;
      grid-template-columns: repeat(10, 32px);
      grid-template-rows: repeat(10, 32px);
      gap: 0;
      background: 
        linear-gradient(90deg, #00ff4105 0%, transparent 50%, #00ff4105 100%),
        linear-gradient(0deg, #00ff4105 0%, transparent 50%, #00ff4105 100%);
      border: 1px solid #00ff4150;
      box-shadow: inset 0 0 15px #00110020;
    }

    .radar-cell {
      width: 32px;
      height: 32px;
      background: linear-gradient(145deg, #001100, #000800);
      border: 1px solid #00ff41; /* Always visible grid lines */
      cursor: crosshair;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      position: relative;
      overflow: hidden;
    }

    .radar-cell::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, transparent 0%, #00ff4105 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .radar-cell:hover::before {
      opacity: 1;
    }

    .radar-cell:hover {
      background: linear-gradient(145deg, #002200, #001100);
      border-color: #00ff41;
      box-shadow: 0 0 8px #00ff4150;
      transform: scale(1.05);
      z-index: 10;
    }

    .radar-cell.vessel {
      background: linear-gradient(145deg, #003300, #002200);
      border-color: #00ff41;
      box-shadow: inset 0 0 5px #00ff4150;
    }

    .radar-cell.vessel::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 4px;
      background: linear-gradient(90deg, #00ff41, #00cc33);
      border-radius: 2px;
      box-shadow: 0 0 5px #00ff41;
    }

    .radar-cell.impact {
      background: radial-gradient(circle, #ff4444, #cc0000);
      border-color: #ff4444;
      color: #fff;
      animation: impactFlash 0.6s ease-out;
      box-shadow: 0 0 15px #ff4444;
    }

    .radar-cell.miss {
      background: radial-gradient(circle, #4444ff, #0000cc);
      border-color: #4444ff;
      color: #fff;
      box-shadow: 0 0 8px #4444ff50;
    }

    .radar-cell.destroyed {
      background: radial-gradient(circle, #ff8800, #cc4400);
      border-color: #ff8800;
      color: #fff;
      animation: destroyedPulse 2s infinite;
      box-shadow: 0 0 12px #ff8800;
    }

    .radar-cell.target-lock {
      background: linear-gradient(145deg, #ffff00, #cccc00);
      border-color: #ffff00;
      animation: targetLock 1s infinite;
      z-index: 5;
    }

    .radar-cell.invalid-target {
      background: linear-gradient(145deg, #ff4444, #cc0000);
      border-color: #ff4444;
      animation: invalidFlash 0.5s ease-out;
    }

    @keyframes impactFlash {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); background: radial-gradient(circle, #fff, #ff4444); }
      100% { transform: scale(1); }
    }

    @keyframes destroyedPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    @keyframes targetLock {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); box-shadow: 0 0 15px #ffff00; }
    }

    @keyframes invalidFlash {
      0% { background: linear-gradient(145deg, #ff4444, #cc0000); }
      50% { background: linear-gradient(145deg, #fff, #ff8888); }
      100% { background: linear-gradient(145deg, #ff4444, #cc0000); }
    }

    .mission-complete {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(0,0,0,0.9), rgba(0,0,0,0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .mission-report {
      background: linear-gradient(145deg, #001100, #000800);
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      border: 3px solid #00ff41;
      box-shadow: 0 0 50px #00ff41;
      color: #00ff41;
      max-width: 600px;
    }

    .mission-report h2 {
      font-size: 2em;
      margin-bottom: 20px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 0 0 15px #00ff41;
    }

    .mission-report button {
      background: linear-gradient(145deg, #00ff41, #00cc33);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 0 10px;
      transition: all 0.3s;
      font-family: 'Orbitron', monospace;
      font-weight: 700;
      text-transform: uppercase;
    }

    .mission-report button:hover {
      background: linear-gradient(145deg, #00cc33, #009922);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px #00ff4150;
    }

    .radar-cell.ship-selected {
      outline: 2px solid #ffff00;
      box-shadow: 0 0 10px #ffff00;
      z-index: 20;
    }

    .exit-btn {
      position: absolute;
      top: 30px;
      right: 40px;
      background: linear-gradient(145deg, #111, #222);
      color: #00ff41;
      border: 2px solid #00ff41;
      border-radius: 8px;
      padding: 8px 22px;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      font-size: 1em;
      letter-spacing: 2px;
      cursor: pointer;
      box-shadow: 0 0 10px #00ff41;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      z-index: 100;
    }
    .exit-btn:hover {
      background: linear-gradient(145deg, #00ff41, #00cc33);
      color: #000;
      box-shadow: 0 0 20px #00ff41;
    }

    .lifetime-record {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      background: linear-gradient(145deg, #001a00, #000800);
      border: 1px solid #00ff4150;
      border-radius: 8px;
      padding: 10px 18px;
      margin-left: 20px;
      min-width: 160px;
      color: #00ff41;
      font-family: 'Orbitron', monospace;
      font-size: 1em;
      font-weight: 700;
      box-shadow: 0 0 10px #00ff4130;
    }
    .lifetime-record-title {
      font-size: 1.05em;
      font-weight: 900;
      letter-spacing: 1px;
      color: #00ff41;
      margin-bottom: 4px;
      text-shadow: 0 0 8px #00ff41;
      text-align: right;
    }
    .lifetime-record-value {
      font-size: 1.2em;
      color: #00ff41;
      text-shadow: 0 0 5px #00ff41;
      margin-bottom: 2px;
      text-align: right;
    }

    .pulse-start {
      animation: pulseStartBtn 1.2s infinite;
      font-size: 1.15em !important;
      box-shadow: 0 0 20px #00ff41, 0 0 40px #00ff41;
      z-index: 10;
      background: linear-gradient(145deg, #00ff41, #00cc33) !important;
      color: #000 !important;
      border-color: #00ff41 !important;
    }
    @keyframes pulseStartBtn {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.13); }
    }

    @media (max-width: 768px) {
      .battle-interface {
        flex-direction: column;
        align-items: center;
      }
      
      .radar-stats {
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .radar-grid {
        grid-template-columns: repeat(10, 28px);
        grid-template-rows: repeat(10, 28px);
      }
      
      .radar-cell {
        width: 28px;
        height: 28px;
        font-size: 10px;
      }
      
      .coordinate-labels span {
        width: 28px;
        height: 28px;
      }

      .coordinate-labels.letters {
        width: 280px;
        left: 18px;
      }

      .coordinate-labels.numbers {
        height: 280px;
        left: -16px;
      }
    }
  </style>
</head>
<body>
  <div class="radar-container">
    <div class="command-header">
      <h1>‚ö° NAVAL RADAR COMMAND ‚ö°</h1>
      <button class="exit-btn" title="Exit to Home / Start New Game" onclick="location.reload()">EXIT</button>
      
      <div class="status-bar">
        <div class="mode-selector" id="mode-selector">
          <button class="mode-btn active" data-mode="classic">Standard</button>
          <button class="mode-btn" data-mode="advanced">Enhanced</button>
        </div>
        
        <div class="radar-stats">
          <div class="stat-item">
            <div class="stat-value" id="player-score">000</div>
            <div>SCORE</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="shots-fired">000</div>
            <div>FIRED</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="hit-ratio">000%</div>
            <div>ACCURACY</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="ships-remaining">05</div>
            <div>TARGETS</div>
          </div>
        </div>
        <div class="lifetime-record" id="lifetime-record">
          <div class="lifetime-record-title">LIFETIME RECORD</div>
          <div class="lifetime-record-value" id="games-played">Games Played: 0</div>
          <div class="lifetime-record-value" id="games-won">Win %: 0%</div>
        </div>
      </div>
    </div>

    <div class="status-message" id="status">
      AWAITING ORDERS - SELECT VESSELS FOR DEPLOYMENT
    </div>

    <div class="battle-interface">
      <div class="ship-command" id="ship-command">
        <h3>üö¢ FLEET COMMAND</h3>
        <div class="fleet-roster">
          <div class="ship-selector" data-type="carrier" data-size="5" draggable="true">CARRIER [5]</div>
          <div class="ship-selector" data-type="battleship" data-size="4" draggable="true">BATTLESHIP [4]</div>
          <div class="ship-selector" data-type="cruiser" data-size="3" draggable="true">CRUISER [3]</div>
          <div class="ship-selector" data-type="submarine" data-size="3" draggable="true">SUBMARINE [3]</div>
          <div class="ship-selector" data-type="destroyer" data-size="2" draggable="true">DESTROYER [2]</div>
        </div>
        
        <div class="command-controls">
          <button class="control-button" id="rotate-btn">‚Üª ROTATE</button>
          <button class="control-button" id="random-btn">‚ö° AUTO DEPLOY</button>
          <button class="control-button" id="clear-btn">‚å´ CLEAR ALL</button>
          <button class="control-button" id="start-battle-btn" disabled>‚ñ∂ START BATTLE</button>
        </div>

        <div class="tactical-systems" id="tactical-systems" style="display: none;">
          <button class="tactical-button" id="sonar-btn" disabled>üì° SONAR [200]</button>
          <button class="tactical-button" id="airstrike-btn" disabled">‚úà AIRSTRIKE [100]</button>
        </div>
      </div>

      <div class="radar-screen">
        <div class="screen-title">üè† HOME SECTOR</div>
        <div class="grid-display">
          <div class="coordinate-labels letters">
            <span>A</span><span>B</span><span>C</span><span>D</span><span>E</span>
            <span>F</span><span>G</span><span>H</span><span>I</span><span>J</span>
          </div>
          <div class="coordinate-labels numbers">
            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
            <span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
          </div>
          <div class="radar-grid" id="player-grid"></div>
        </div>
      </div>

      <div class="radar-screen">
        <div class="screen-title">üéØ ENEMY SECTOR</div>
        <div class="grid-display">
          <div class="coordinate-labels letters">
            <span>A</span><span>B</span><span>C</span><span>D</span><span>E</span>
            <span>F</span><span>G</span><span>H</span><span>I</span><span>J</span>
          </div>
          <div class="coordinate-labels numbers">
            <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
            <span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
          </div>
          <div class="radar-grid" id="enemy-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Game state
    let gameMode = 'classic';
    let gamePhase = 'setup';
    let playerGrid = Array(10).fill().map(() => Array(10).fill(null));
    let enemyGrid = Array(10).fill().map(() => Array(10).fill(null));
    let playerShips = [];
    let enemyShips = [];
    let selectedShip = null;
    let orientation = 'horizontal';
    let playerTurn = true;
    let gameOver = false;
    let gameStats = {
      score: 0,
      shotsFired: 0,
      hits: 0,
      enemyShipsRemaining: 5
    };

    const SHIPS = [
      { type: 'carrier', size: 5, name: 'Aircraft Carrier' },
      { type: 'battleship', size: 4, name: 'Battleship' },
      { type: 'cruiser', size: 3, name: 'Cruiser' },
      { type: 'submarine', size: 3, name: 'Submarine' },
      { type: 'destroyer', size: 2, name: 'Destroyer' }
    ];

    // Initialize game
    function initGame() {
      createGrids();
      setupEventListeners();
      updateStatus('Select your ships and deploy them on your grid, Admiral!');
    }

    // Create grid displays
    function createGrids() {
      createGrid('player-grid', 'player');
      createGrid('enemy-grid', 'enemy');
    }

    function createGrid(containerId, gridType) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      for (let row = 0; row < 10; row++) {
        for (let col = 0; col < 10; col++) {
          const cell = document.createElement('div');
          cell.className = 'radar-cell';
          cell.dataset.row = row;
          cell.dataset.col = col;
          cell.dataset.grid = gridType;
          
          if (gridType === 'player') {
            // Only allow drop events for drag-and-drop
            cell.addEventListener('dragover', handleCellDragOver);
            cell.addEventListener('drop', handleCellDrop);
          } else if (gridType === 'enemy' && gamePhase === 'playing') {
            cell.addEventListener('click', () => handleEnemyGridClick(row, col));
          }
          
          container.appendChild(cell);
        }
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Mode selection
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => selectGameMode(btn.dataset.mode));
      });

      // Ship selection (click)
      document.querySelectorAll('.ship-selector').forEach(ship => {
        ship.addEventListener('click', () => selectShip(ship));
        // Drag-and-drop events for ships
        ship.addEventListener('dragstart', handleShipDragStart);
        ship.addEventListener('dragend', handleShipDragEnd);
      });

      // Control buttons
      document.getElementById('rotate-btn').addEventListener('click', rotateVessel);
      document.getElementById('random-btn').addEventListener('click', randomPlacement);
      document.getElementById('clear-btn').addEventListener('click', clearAllShips);
      const startBtn = document.getElementById('start-battle-btn');
      startBtn.removeEventListener('click', startGame);
      startBtn.addEventListener('click', startGame);

      // Powerups
      document.getElementById('sonar-btn').addEventListener('click', useSonar);
      document.getElementById('airstrike-btn').addEventListener('click', useAirstrike);

      // Drag-and-drop events for player grid cells
      document.querySelectorAll('[data-grid="player"] .radar-cell').forEach(cell => {
        cell.addEventListener('dragover', handleCellDragOver);
        cell.addEventListener('drop', handleCellDrop);
      });
    }

    // Game mode selection
    function selectGameMode(mode) {
      gameMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      
      const powerupsDiv = document.getElementById('tactical-systems');
      powerupsDiv.style.display = mode === 'advanced' ? 'block' : 'none';
      
      updateStatus(mode === 'classic' 
        ? 'Classic Mode: Traditional naval warfare!' 
        : 'Advanced Mode: Strategic warfare with tactical support!');
    }

    // Ship selection
    function selectShip(shipElement) {
      if (shipElement.classList.contains('deployed')) return;
      
      document.querySelectorAll('.ship-selector').forEach(s => s.classList.remove('selected'));
      shipElement.classList.add('selected');
      
      const shipType = shipElement.dataset.type;
      selectedShip = SHIPS.find(s => s.type === shipType);
      updateStatus(`${selectedShip.name} selected! Click on your grid to deploy (${orientation}).`);
    }

    // Show placement preview
    function showPlacementPreview(row, col) {
      // Only show preview if dragging a ship or moving a ship
      if (!(draggedShip || movingShip)) return;
      let ship = draggedShip || movingShip || selectedShip || selectedPlacedShip;
      if (!ship || gamePhase !== 'setup') return;
      clearPlacementPreview();
      // For moving a placed ship, use its orientation and size
      const orientationToUse = ship.orientation || orientation;
      const canPlace = canPlaceShip(playerGrid, row, col, ship.size, orientationToUse);
      for (let i = 0; i < ship.size; i++) {
        const targetRow = row + (orientationToUse === 'vertical' ? i : 0);
        const targetCol = col + (orientationToUse === 'horizontal' ? i : 0);
        if (targetRow < 10 && targetCol < 10) {
          const cell = document.querySelector(`[data-grid="player"][data-row="${targetRow}"][data-col="${targetCol}"]`);
          if (cell) {
            if (canPlace) {
              cell.classList.add('selected');
            } else {
              cell.classList.add('invalid-target');
            }
          }
        }
      }
    }

    function clearPlacementPreview() {
      document.querySelectorAll('[data-grid="player"] .radar-cell').forEach(cell => {
        cell.classList.remove('selected', 'invalid-target');
      });
    }

    // Check if ship can be placed
    function canPlaceShip(grid, row, col, size, orientation) {
      for (let i = 0; i < size; i++) {
        const targetRow = row + (orientation === 'vertical' ? i : 0);
        const targetCol = col + (orientation === 'horizontal' ? i : 0);
        
        if (targetRow >= 10 || targetCol >= 10 || grid[targetRow][targetCol]) {
          return false;
        }
      }
      return true;
    }

    // Handle player grid click (ship placement)
    function handlePlayerGridClick(row, col) {
      if (!selectedShip || gamePhase !== 'setup') return;
      
      if (!canPlaceShip(playerGrid, row, col, selectedShip.size, orientation)) {
        updateStatus('Cannot deploy there, Admiral! Choose different coordinates.');
        return;
      }
      
      placeShip(row, col);
    }

    // Place ship on grid
    function placeShip(row, col) {
      // Prevent placing more than 5 ships
      if (playerShips.length >= 5) {
        updateStatus('All ships already deployed!');
        return;
      }
      // Prevent placing the same ship more than once
      if (playerShips.some(s => s.type === selectedShip.type)) {
        updateStatus('This ship is already deployed!');
        return;
      }
      const shipCells = [];
      
      for (let i = 0; i < selectedShip.size; i++) {
        const targetRow = row + (orientation === 'vertical' ? i : 0);
        const targetCol = col + (orientation === 'horizontal' ? i : 0);
        
        playerGrid[targetRow][targetCol] = selectedShip.type;
        shipCells.push({ row: targetRow, col: targetCol });
      }
      
      playerShips.push({
        ...selectedShip,
        cells: shipCells,
        hits: 0,
        sunk: false,
        orientation // make sure orientation is tracked
      });

      // Mark ship as placed in the sidebar
      const sidebarShip = document.querySelector(`[data-type="${selectedShip.type}"]`);
      sidebarShip.classList.add('deployed');
      sidebarShip.setAttribute('draggable', 'false');
      sidebarShip.removeEventListener('dragstart', handleShipDragStart);
      sidebarShip.removeEventListener('click', selectShip);
      // Automatically select the newly placed ship for rotation
      selectPlacedShip(playerShips[playerShips.length - 1]);
      selectedShip = null;
      
      updatePlayerGrid();
      clearPlacementPreview();
      addShipGridClickHandlers(); // ensure click handlers are refreshed
      updateStartBattleButton(); // Update button state after placing a ship
    }

    // Update grid displays
    function updatePlayerGrid() {
      for (let row = 0; row < 10; row++) {
        for (let col = 0; col < 10; col++) {
          const cell = document.querySelector(`[data-grid="player"][data-row="${row}"][data-col="${col}"]`);
          const cellValue = playerGrid[row][col];
          cell.className = 'radar-cell';
          cell.removeAttribute('draggable'); // Reset draggable
          cell.ondragstart = null;
          cell.ondragend = null;
          if (cellValue && cellValue !== 'hit' && cellValue !== 'miss') {
            cell.classList.add('vessel');
            // Make ship cells draggable
            cell.setAttribute('draggable', 'true');
            cell.ondragstart = (e) => handlePlacedShipDragStart(e, row, col);
            cell.ondragend = handlePlacedShipDragEnd;
          } else if (cellValue === 'hit') {
            cell.classList.add('impact');
            cell.textContent = 'üí•';
          } else if (cellValue === 'miss') {
            cell.classList.add('miss');
            cell.textContent = 'üíß';
          }
        }
      }
    }

    function updateEnemyGrid() {
      for (let row = 0; row < 10; row++) {
        for (let col = 0; col < 10; col++) {
          const cell = document.querySelector(`[data-grid="enemy"][data-row="${row}"][data-col="${col}"]`);
          const cellValue = enemyGrid[row][col];
          
          cell.className = 'radar-cell';
          if (cellValue === 'hit') {
            cell.classList.add('impact');
            cell.textContent = 'üí•';
          } else if (cellValue === 'miss') {
            cell.classList.add('miss');
            cell.textContent = 'üíß';
          }
          
          // Check if part of sunk ship
          const sunkShip = enemyShips.find(ship => 
            ship.sunk && ship.cells.some(c => c.row === row && c.col === col)
          );
          if (sunkShip) {
            cell.classList.add('destroyed');
            cell.textContent = 'üî•';
          }
        }
      }
    }

    // Control functions
    function rotateVessel() {
      // Only rotate if a placed ship is selected
      if (selectedPlacedShip) {
        const old = selectedPlacedShip;
        // Remove ship from grid
        old.cells.forEach(cell => { playerGrid[cell.row][cell.col] = null; });
        // Try new orientation
        const newOrientation = old.orientation === 'horizontal' ? 'vertical' : 'horizontal';
        const base = old.cells[0];
        let canRotate = true;
        let newCells = [];
        for (let i = 0; i < old.size; i++) {
          const row = newOrientation === 'vertical' ? base.row + i : base.row;
          const col = newOrientation === 'horizontal' ? base.col + i : base.col;
          if (row >= 10 || col >= 10 || playerGrid[row][col]) {
            canRotate = false;
            break;
          }
          newCells.push({ row, col });
        }
        if (canRotate) {
          // Place ship in new orientation
          newCells.forEach(cell => { playerGrid[cell.row][cell.col] = old.type; });
          old.cells = newCells;
          old.orientation = newOrientation;
          updatePlayerGrid();
          addShipGridClickHandlers();
          updateStatus(`${old.name.toUpperCase()} ROTATED TO ${newOrientation.toUpperCase()}`);
        } else {
          // Restore old placement
          old.cells.forEach(cell => { playerGrid[cell.row][cell.col] = old.type; });
          updateStatus('NOT ENOUGH SPACE TO ROTATE HERE!');
        }
        return;
      }
      // If no placed ship is selected, do nothing and show a message
      updateStatus('SELECT A PLACED SHIP ON THE GRID TO ROTATE IT.');
    }

    // Lifetime record logic
    function updateLifetimeRecordDisplay() {
      const gamesPlayed = parseInt(localStorage.getItem('battleship_gamesPlayed') || '0', 10);
      const gamesWon = parseInt(localStorage.getItem('battleship_gamesWon') || '0', 10);
      const winPct = gamesPlayed > 0 ? Math.round((gamesWon / gamesPlayed) * 100) : 0;
      document.getElementById('games-played').textContent = `Games Played: ${gamesPlayed}`;
      document.getElementById('games-won').textContent = `Win %: ${winPct}%`;
    }
    // Call on load
    updateLifetimeRecordDisplay();
    // Update after game ends
    function updateLifetimeRecord(won) {
      let gamesPlayed = parseInt(localStorage.getItem('battleship_gamesPlayed') || '0', 10);
      let gamesWon = parseInt(localStorage.getItem('battleship_gamesWon') || '0', 10);
      gamesPlayed++;
      if (won) gamesWon++;
      localStorage.setItem('battleship_gamesPlayed', gamesPlayed);
      localStorage.setItem('battleship_gamesWon', gamesWon);
      updateLifetimeRecordDisplay();
    }

    // Initialize game when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initGame();
    });

    // --- Drag-and-drop handlers for ships ---
    let draggedShip = null;
    function handleShipDragStart(e) {
      if (this.classList.contains('deployed')) {
        e.preventDefault();
        return;
      }
      draggedShip = SHIPS.find(s => s.type === this.dataset.type);
      // Store ship type and orientation in dataTransfer
      e.dataTransfer.setData('text/plain', JSON.stringify({
        type: draggedShip.type,
        size: draggedShip.size,
        orientation: 'horizontal' // Always start horizontal for drag
      }));
    }
    function handleShipDragEnd(e) {
      draggedShip = null;
      clearPlacementPreview();
    }
    // --- Drag-and-drop handlers for moving placed ships ---
    let movingShip = null;
    let movingShipOriginalCells = null;
    function handlePlacedShipDragStart(e, row, col) {
      // Only allow drag if this cell is part of a ship
      const shipType = playerGrid[row][col];
      if (!shipType) return;
      const ship = playerShips.find(s => s.type === shipType && s.cells.some(c => c.row === row && c.col === col));
      if (!ship) return;
      movingShip = ship;
      movingShipOriginalCells = [...ship.cells.map(c => ({...c}))];
      // Remove ship from grid for preview
      ship.cells.forEach(cell => { playerGrid[cell.row][cell.col] = null; });
      updatePlayerGrid();
      addShipGridClickHandlers();
      // Set dataTransfer for drop
      e.dataTransfer.setData('text/plain', JSON.stringify({
        type: ship.type,
        size: ship.size,
        orientation: ship.orientation
      }));
      // Show preview at current location
      const base = movingShipOriginalCells[0];
      showPlacementPreview(base.row, base.col);
    }
    function handlePlacedShipDragEnd(e) {
      // If not dropped in a valid spot, restore ship
      if (movingShip && movingShipOriginalCells) {
        // If the ship is not on the grid (cells are empty), restore
        if (!movingShip.cells.some(cell => playerGrid[cell.row][cell.col] === movingShip.type)) {
          movingShipOriginalCells.forEach(cell => { playerGrid[cell.row][cell.col] = movingShip.type; });
          movingShip.cells = movingShipOriginalCells;
          updatePlayerGrid();
          addShipGridClickHandlers();
        }
      }
      movingShip = null;
      movingShipOriginalCells = null;
    }
    // --- Drag-and-drop handlers for grid cells ---
    function handleCellDragOver(e) {
      e.preventDefault(); // Allow drop
      let dragData = null;
      try {
        dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
      } catch {}
      if (!dragData || gamePhase !== 'setup') return;
      const row = parseInt(this.dataset.row);
      const col = parseInt(this.dataset.col);
      const canDeploy = canPlaceShip(playerGrid, row, col, dragData.size, dragData.orientation);
      selectedShip = draggedShip || movingShip;
      showPlacementPreview(row, col);
    }
    function handleCellDrop(e) {
      e.preventDefault();
      let dragData = null;
      try {
        dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
      } catch {}
      if (!dragData || gamePhase !== 'setup') return;
      const row = parseInt(this.dataset.row);
      const col = parseInt(this.dataset.col);

      // Helper to try placing at a given cell
      function tryPlaceAt(r, c) {
        return canPlaceShip(playerGrid, r, c, dragData.size, dragData.orientation);
      }

      // Try the exact cell first
      let found = false;
      let targetRow = row;
      let targetCol = col;
      if (tryPlaceAt(row, col)) {
        found = true;
      } else {
        // Search nearby cells in a 3x3 area
        outer: for (let dr = -1; dr <= 1; dr++) {
          for (let dc = -1; dc <= 1; dc++) {
            const nr = row + dr;
            const nc = col + dc;
            if (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && tryPlaceAt(nr, nc)) {
              targetRow = nr;
              targetCol = nc;
              found = true;
              break outer;
            }
          }
        }
      }

      if (!found) {
        updateStatus('DEPLOYMENT BLOCKED - SELECT ALTERNATIVE COORDINATES');
        clearPlacementPreview();
        // Restore moving ship if needed
        if (movingShip && movingShipOriginalCells) {
          movingShipOriginalCells.forEach(cell => { playerGrid[cell.row][cell.col] = movingShip.type; });
          movingShip.cells = movingShipOriginalCells;
          updatePlayerGrid();
          addShipGridClickHandlers();
        }
        movingShip = null;
        movingShipOriginalCells = null;
        return;
      }

      // If moving a placed ship
      if (movingShip) {
        const shipName = movingShip.name; // Store the name before setting to null
        const shipCells = [];
        for (let i = 0; i < dragData.size; i++) {
          const targetRow2 = targetRow + (dragData.orientation === 'vertical' ? i : 0);
          const targetCol2 = targetCol + (dragData.orientation === 'horizontal' ? i : 0);
          playerGrid[targetRow2][targetCol2] = movingShip.type;
          shipCells.push({ row: targetRow2, col: targetCol2 });
        }
        movingShip.cells = shipCells;
        movingShip.orientation = dragData.orientation;
        updatePlayerGrid();
        addShipGridClickHandlers();
        selectPlacedShip(movingShip);
        movingShip = null;
        movingShipOriginalCells = null;
        clearPlacementPreview();
        updateStatus(`${shipName} moved successfully!`);
        updateStartBattleButton(); // Update button state after moving a ship
        return;
      }
      // If placing a new ship from the Fleet panel
      if (draggedShip) {
        selectedShip = draggedShip;
        placeShip(targetRow, targetCol);
        draggedShip = null;
        clearPlacementPreview();
      }
    }

    function randomPlacement() {
      gamePhase = 'setup'; // Ensure game phase is reset so Start Battle works
      // Clear the board first
      playerGrid = Array(10).fill().map(() => Array(10).fill(null));
      playerShips = [];
      selectedShip = null;
      document.querySelectorAll('.ship-selector').forEach(ship => {
        ship.classList.remove('deployed', 'selected');
        ship.setAttribute('draggable', 'true');
        ship.addEventListener('dragstart', handleShipDragStart);
        ship.addEventListener('click', () => selectShip(ship));
      });
      document.getElementById('start-battle-btn').disabled = true;
      document.getElementById('start-battle-btn').classList.remove('pulse-start');

      // Try to place each ship randomly
      SHIPS.forEach(ship => {
        let placed = false;
        let attempts = 0;
        while (!placed && attempts < 100) {
          const orientation = Math.random() > 0.5 ? 'horizontal' : 'vertical';
          const row = Math.floor(Math.random() * (orientation === 'vertical' ? 11 - ship.size : 10));
          const col = Math.floor(Math.random() * (orientation === 'horizontal' ? 11 - ship.size : 10));
          if (canPlaceShip(playerGrid, row, col, ship.size, orientation)) {
            // Place the ship
            const shipCells = [];
            for (let i = 0; i < ship.size; i++) {
              const targetRow = row + (orientation === 'vertical' ? i : 0);
              const targetCol = col + (orientation === 'horizontal' ? i : 0);
              playerGrid[targetRow][targetCol] = ship.type;
              shipCells.push({ row: targetRow, col: targetCol });
            }
            playerShips.push({
              ...ship,
              cells: shipCells,
              hits: 0,
              sunk: false,
              orientation
            });
            document.querySelector(`[data-type="${ship.type}"]`).classList.add('deployed');
            placed = true;
          }
          attempts++;
        }
      });

      updatePlayerGrid();
      addShipGridClickHandlers();
      // Auto-select the first ship for rotation (optional, or set to null for none)
      if (playerShips.length > 0) {
        selectPlacedShip(playerShips[0]);
      }
      document.getElementById('start-battle-btn').disabled = false;
      document.getElementById('start-battle-btn').classList.remove('pulse-start');
      updateStatus('Fleet auto-deployed! All ships battle-ready, Admiral!');
      updateStartBattleButton(); // Update button state after auto-deploy
    }

    let selectedPlacedShip = null;
    function selectPlacedShip(ship) {
      document.querySelectorAll('[data-grid="player"] .radar-cell').forEach(cell => cell.classList.remove('ship-selected'));
      ship.cells.forEach(cellInfo => {
        const cell = document.querySelector(`[data-grid="player"][data-row="${cellInfo.row}"][data-col="${cellInfo.col}"]`);
        if (cell) cell.classList.add('ship-selected');
      });
      selectedPlacedShip = ship;
      updatePlayerGrid(); // Refresh grid so only this ship is draggable
      updateStatus(`${ship.name.toUpperCase()} SELECTED - CLICK ROTATE OR DRAG TO MOVE`);
    }

    function addShipGridClickHandlers() {
      // Remove previous listeners and selection
      document.querySelectorAll('[data-grid="player"] .radar-cell').forEach(cell => {
        cell.classList.remove('ship-selected');
        cell.ondragstart = null;
        cell.ondragend = null;
      });
      // DO NOT add any click listeners to ship cells
    }

    function clearAllShips() {
      gamePhase = 'setup'; // Ensure game phase is reset so Start Battle works
      playerGrid = Array(10).fill().map(() => Array(10).fill(null));
      playerShips = [];
      selectedShip = null;
      document.querySelectorAll('.ship-selector').forEach(ship => {
        ship.classList.remove('deployed', 'selected');
        ship.setAttribute('draggable', 'true');
        ship.addEventListener('dragstart', handleShipDragStart);
        ship.addEventListener('click', () => selectShip(ship));
      });
      document.getElementById('start-battle-btn').disabled = true;
      document.getElementById('start-battle-btn').classList.remove('pulse-start');
      updateStatus('All ships cleared. Select your ships and deploy them on your grid, Admiral!');
      updateStartBattleButton(); // Update button state after clearing all ships
    }

    function startGame() {
      if (playerShips.length !== 5) {
        updateStatus('Deploy all ships before starting the battle, Admiral!');
        return;
      }
      gamePhase = 'playing';
      document.getElementById('start-battle-btn').disabled = true;
      document.getElementById('start-battle-btn').classList.remove('pulse-start');
      updateStatus('Your turn to fire! Select a target on the enemy grid.');
      // (Add any additional logic to actually start the game here)
    }

    function showMissionCompleteScreen(won) {
      const missionCompleteDiv = document.createElement('div');
      missionCompleteDiv.className = 'mission-complete';
      missionCompleteDiv.innerHTML = `
        <div class="mission-report">
          <h2>${won ? 'MISSION COMPLETE' : 'MISSION FAILED'}</h2>
          <p>You ${won ? 'successfully completed' : 'failed to complete'} the mission.</p>
          <button onclick="location.reload()">PLAY AGAIN</button>
        </div>
      `;
      document.body.appendChild(missionCompleteDiv);
    }

    function useSonar() {
      updateStatus('Sonar activated! Revealing nearby enemy ships.');
      // In a real game, this would reveal nearby enemy ship cells
      // For now, it just shows a message
    }

    function useAirstrike() {
      updateStatus('Airstrike launched! Targeting enemy ships.');
      // In a real game, this would deal damage to nearby enemy ship cells
      // For now, it just shows a message
    }

    // Test function for debugging - call this from browser console
    function testStartButton() {
      console.log('Testing start button...');
      console.log('Button element:', document.getElementById('start-battle-btn'));
      console.log('Button disabled:', document.getElementById('start-battle-btn').disabled);
      console.log('Player ships:', playerShips.length);
      console.log('Game phase:', gamePhase);
      
      // Try to manually trigger the click
      document.getElementById('start-battle-btn').click();
    }

    // --- START BATTLE BUTTON LOGIC ---
    function updateStartBattleButton() {
      const btn = document.getElementById('start-battle-btn');
      if (playerShips.length === 5) {
        btn.disabled = false;
        btn.classList.add('pulse-start');
      } else {
        btn.disabled = true;
        btn.classList.remove('pulse-start');
      }
    }
  </script>
</body>
</html>
